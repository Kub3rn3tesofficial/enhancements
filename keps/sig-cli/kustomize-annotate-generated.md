---
title: Kustomize Annotate Generated Secrets and ConfigMaps
authors:
 - "@pwittrock"
owning-sig: sig-cli
participating-sigs:
 - sig-cli
reviewers:
 - "@janetkuo"
 - "@anguslees"
approvers:
 - "@monopole"
editors:
 - "@pwittrock"
creation-date: 2019-03-01
last-updated: 2019-03-01
status: provisional
see-also:
replaces:
superseded-by:
 - n/a
---

# Kustomize Annotate Generated Secrets and ConfigMaps

## Table of Contents
* [Table of Contents](#table-of-contents)
* [Summary](#summary)
* [Motivation](#motivation)
  * [Goals](#goals)
  * [Non-Goals](#non-goals)
* [Proposal](#proposal)
  * [Implementation Details/Notes/Constraints](#implementation-detailsnotesconstraints)
  * [Risks and Mitigations](#risks-and-mitigations)
* [Graduation Criteria](#graduation-criteria)
* [Implementation History](#implementation-history)
* [Alternatives](#alternatives)

[Tools for generating]: https://github.com/ekalinin/github-markdown-toc

## Summary

- Annotate generated Secrets and ConfigMaps with Workloads the reference them
- Annotated Workloads with the Secrets and ConfigMaps they reference
- Workload annotations are retained after the Workloads stop referencing the Secrets and ConfigMaps
- Secret and ConfigMap annotations are retained after the Workloads stop referencing them

## Motivation

- Kustomize generates Secret and ConfigMap Resources which are referenced by Workloads
  - When the data for the Secrets or ConfigMaps change, new Secret or ConfigMap Resources are generated
  - Kustomize updates the Workloads to refer to the new Resources, and stop referring to the old Resources
  - References to the old Secret and ConfigMap Resources are leaked when new Resources are generated
  - The information that the Resources were generated by Kustomize rather than explicitly defined by
    users is lost

### Goals

- Provide provenance for Resources generated by Kustomize
  - Retain a record of Secret and ConfigMap Resources generated by Kustomize.
  - Retain a record of which Workloads each generated Secret and ConfigMap was consumed by.
  - Retain a record of which generated Secret and ConfigMap Resources each Workload consumed.
- Allow other tools to identify generated Secrets and ConfigMaps that are no longer in use as
  candidates for garbage collection.

### Non-Goals

## Proposal

Kustomize already modifies Workloads that refer to generated Secrets and ConfigMaps by updating
the names to match the generated names.

### Annotations on Workloads

Set an annotation on each Workload for each generated Secret and ConfigMap it references.  When
using Apply, these annotations will be retained even after Kustomize stops generating them.

**Secret Annotation:** `generated-secret.kustomize.sigs.k8s.io/<generated-secret--name>=`
**ConfigMap Annotation:** `generated-configmap.kustomize.sigs.k8s.io/<generated-configmap-name>=`

### Annotations on Generated Secret and ConfigMap Resources  

Set an annotation on each generated Secret and ConfigMap Resource for each Workload that
consumes it.  These annotations will be retained even after Kustomize stops generating them.

**Secret Annotation:** `secret-reference.kustomize.sigs.k8s.io/<workload-group>.<workload-kind>.<workload-name>=`
**ConfigMap Annotation:** `configmap-reference.kustomize.sigs.k8s.io/<workload-group>.<workload-kind>.<workload-name>=`

Generated Secret and ConfigMap Resources should also have an annotation stating that
they were generated.

**Annotation:** `kustomize.sigs.k8s.io/generated=`


### Risks and Mitigations

Because the list of annotations don't get deleted, they will grow over time.  This is also
true of the generated Resources themselves.  This can be mitigated by having the process
that cleans up Secrets and ConfigMaps remove the annotations from the Workloads.

This behavior can be disabled by setting `annotateProvenance: false`.

## Graduation Criteria

NA

## Docs

Update Kustomize generateSecret and generateConfigMap documentation

## Test plan

### Version Skew Tests

NA

## Implementation History

## Alternatives
