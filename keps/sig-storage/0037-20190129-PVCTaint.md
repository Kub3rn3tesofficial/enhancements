---
kep-number: 37
title: PVC Taint and Toleration
authors:
  - "@jingxu97"
owning-sig: sig-storage
participating-sigs:
  - sig-storage
  - sig-architecture
reviewers:
  - "@saad-ali"
  - "@liggitt"
  - "@davidopp"
approvers:
  - "@liggitt"
  - "@saad-ali"
editor: TBD
creation-date: 2019-1-29
last-updated: 2019-1-29
status: implementable
see-also:
  - n/a
replaces:
  - n/a
superseded-by:
  - n/a
---

# Title

PVC/PV Taint and Toleration

## Table of Contents

  * [Title](#title)
      * [Table of Contents](#table-of-contents)
      * [Summary](#summary)
      * [Motivation](#motivation)
         * [Goals](#goals)
         * [Non-Goals](#non-goals)
      * [Proposal](#proposal)
         * [User Stories](#user-stories)
      * [Workarounds](#workarounds)
      * [Alternatives](#alternatives)
         * [Risks and Mitigations](#risks-and-mitigations)
      * [Graduation Criteria](#graduation-criteria)
      * [Implementation History](#implementation-history)

## Summary

The current Taint and Toleration feature allows users to mark a node (taint the node) so that no pods can be scheduled to it, unless a pod explicitly tolerates the taint. This proposal is trying to extend this concept on a volume. User or admin (or controller) can mark a volume (taint the PVC or PV) so that no pods could start to use them unless a pod can tolerate the taint. This feature is very useful for some storage operations such as volume snapshot/clone and data population.  

## Motivation

Currently in our volume management design, k8s only supports provisioning an empty volume and a volume can be used by a pod immediately after it is created. With the new features on storage and data management becoming available such as snapshots, clone, and data population, data might be restored or populated to the volumes. We need a way to indicate when the data is available on the volume so that pod can start using it. 

Previously, we proposed to use Readiness Gate for this problem, however, this approach lacks the support the scenarios that some special Pods (e.g., Pods for populating the data) can be allowed to use the volume even when the data is not ready.

Taint and toleration feature currently used for marking node and reacting based
on the taint effect seems also provides a nice way to solve this volume issue.

### Goals

This proposal is trying to investigate the taint and toleration feature applied
to PVC/PV. It will identify the use cases that this feature could be applied to
and describe the workflow of how this feature can be used.

### Non-Goals


## Proposal

The idea of Taints and tolerations is that they work together to ensure that pods are not scheduled or executed onto inappropriate nodes. When a taint is applied to a node, this marks that the node should not accept (or execute based on the TaintEffect) any pods that do not tolerate the taints. Tolerations are applied to pods, and allow (but do not require) the pods to schedule onto nodes with matching taints.

Currently, Kubernetes already supports three types of taint effects: 
- NoSchedule: Pods that do not tolerate this taint are not scheduled on the node.
- PreferNoSchedule: Kubernetes avoids scheduling Pods that do not tolerate this taint onto the node.
- NoExecute: Pod is evicted from the node if it is already running on the node, and is not scheduled
onto the node if it is not yet running on the node.

Considering the motivation for volume management, there are also certain cases that we want to taint the volume so that Pods should not start to use those volumes (or stop to use those volumes) unless the pods can tolerate the taints applied to the volumes. Based on the use cases, we currently propose two effects for volume taint
- NoAttachOrMount: Pods that do not tolerate this taint cannot start to attach or mount volume if tainted.
- NoUse (StopUse?): Pods will be stopped (deleted) if they care currently using the volume that is tainted.

For example,
```
taint := &v1.Taint{
	Key:    dataNotReady,
	Value:  "true",
	Effect: v1.TaintEffectNoAttachOrMount,
}
```

We have choices of either tainting the PVC or PV. 

### Taint PV

- For dynamic provisioning: when provisioner creates an empty volume, it can check if the data has not populated from the specified data source into the volume and taint the PV with the NoAttachorMount taint. Because of this taint, when attach_detach_controller or volume manager receives this volume, it will not trigger volume operation unless the Pod which references this volume has a toleration of the taint. 
The data populator controller should run in a Pod with a toleration of the taint so that it can attach and mount the volume and then populate the data to the volume. After the data is populated, the controller can remove the DataNotReady taint from the PV.

- For static provisioning, system admin could taint the PV when applicable. Similar to dynamic provisioning, after data is populated, the taint will be removed from the PV by the controller.


### Taint PVC

It might be also beneficial to allow users to taint a PVC for other purposes, e.g., to avoid the PVC is used immediately by some pod. In this case, the attach_detach_controller or volume manager should check the taint for PVC besides PV and take actions accordingly.  In addition, data populator controller needs to remove the taint from either PVC or PV

## API Change

```
// The volume this VolumeTaint is attached to has the "effect" on
// any pod that does not tolerate the VolumeTaint.
type VolumeTaint struct {
	// Required. The taint key to be applied to a volume.
	Key string
	// Required. The taint value corresponding to the taint key.
	// +optional
	Value string
	// Required. The effect of the taint on pods
	// that do not tolerate the taint.
	// Valid effects are NoAttachOrMount, NoUse.
	Effect VolumeTaintEffect
	// TimeAdded represents the time at which the taint was added.
	// It is only written for NoUse taints.
	// +optional
	TimeAdded *metav1.Time
}

type VolumeTaintEffect string
const (
	// Do not allow new pods to start attach or mount the volume unless they tolerate the taint,
	// Enforced by the attach_detach controller and kubelet volume manager.
	TaintEffectNoAttachOrMount VolumeTaintEffect = "NoAttachOrMount"

	// Delete any already-running pods that do not tolerate the taint.
	// Enforced by volume controller.
	TaintEffectNoUse VolumeTaintEffect = "NoUse"
}


// The pod this VolumeToleration is attached to tolerates any VolumeTaint that matches
// the triple <key,value,effect> using the matching operator <operator>.
type VolumeToleration struct {
	// Key is the taint key that the toleration applies to. Empty means match all taint keys.
	// If the key is empty, operator must be Exists; this combination means to match all values and all keys.
	// +optional
	Key string
	// Operator represents a key's relationship to the value.
	// Valid operators are Exists and Equal. Defaults to Equal.
	// Exists is equivalent to wildcard for value, so that a pod can
	// tolerate all taints of a particular category.
	// +optional
	Operator TolerationOperator
	// Value is the taint value the toleration matches to.
	// If the operator is Exists, the value should be empty, otherwise just a regular string.
	// +optional
	Value string
	// Effect indicates the taint effect to match. Empty means match all taint effects.
	// When specified, allowed values are NoSchedule, PreferNoSchedule and NoExecute.
	// +optional
	Effect VolumeTaintEffect
	// TolerationSeconds represents the period of time the toleration (which must be
	// of effect NoUse, otherwise this field is ignored) tolerates the taint. By default,
	// it is not set, which means tolerate the taint forever (do not evict). Zero and
	// negative values will be treated as 0 (evict immediately) by the system.
	// +optional
	TolerationSeconds *int64
}

type PersistentVolumeSpec struct {

  ...
  VolumeTaints []VolumeTaint
  ...

}

type PersistentVolumeClaimSpec struct {

  ...
  VolumeTaints []VolumeTaint
  ...

}


// PodSpec is a description of a pod
type PodSpec struct {

  ...
  // If specified, the pod's tolerations for node's taint.
	// +optional
	Tolerations []Toleration

   // If specified, the pod's tolerations for volume's taint.
	// +optional
  VolumeTolerations []VolumeToleration

  ...
}
```

## User Stories

- Data Snapshot/Clone/Population: Taint the PV if data has not yet populated
  into the volume so that no pods could use them. After verifying that the data is ready in the volume, remove the taint.

- Migrating PV type: This use case is referring to change the PV type, e.g. convert iscsi PV to csi PV in-place. During migration, the pods that are currently using the volume should be stopped (deleted) and PVC will unbind the old PV and rebind to the new PV

- PV health monitoring: If a volume driver reports a volume as unhealthy, volume controller could taint the volume with an effect that could trigger to evict the Pod using the volume.

## Alternatives

## Risks and Mitigations

- If PVC/PV is tainted after it is already attached/mounted, no special action should be taken. Controller could emit events to describe that the taint is not effective after volume is already attached/mounted.

## Graduation Criteria

## Implementation History


